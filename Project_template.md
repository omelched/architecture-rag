# RAG-бот

## Исследование моделей и инфраструктуры

### Сравнение LLM-моделей

| класс моделей | качество ответов                                        | скорость работы                                     | стоимость владения                            | удобство и простота                                           |
| ------------- | ------------------------------------------------------- | --------------------------------------------------- | --------------------------------------------- | ------------------------------------------------------------- |
| локальные     | ниже решений-"китов", зависит от модели и ее подготовки | низкая, обработка выполняется на мощностях компании | низкая, включает в себя только инфраструктуру | низкие, требует настройки инфраструктуры и внедрения ModelOps |
| облачные      | высокое, модели обучены на больших объёмах данных       | высокая, благодаря публикации в облаке as a service | высокая, цена за каждое обращение             | высокие, требуется лишь интеграция по REST API                |

### Сравнение моделей эмбеддингов

| модель эмбеддинга     | скорость создания индекса                                                                         | качество поиска                                                           | стоимость владения                            |
| --------------------- | ------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------- | --------------------------------------------- |
| Sentence-Transformers | может быть медленнее по сравнению с облачными моделями, зависит от инфраструктуры и объема данных | может уступать облачным моделям из-за меньшего объёма данных для обучения | низкая, включает в себя только инфраструктуру |
| OpenAI Embeddings     | высокая благодаря публикации в облаке as a service                                                | высокое, большой объем данных для оптимизации алгоритма                   | высокая, цена за каждое обращение             |

### Сравнение векторных баз ChromaDB и FAISS

| векторная БД | скорость поиска и индексации                                                            | сложность внедрения и поддержки                            | удобство в работе                                           | стоимость владения                                              |
| ------------ | --------------------------------------------------------------------------------------- | ---------------------------------------------------------- | ----------------------------------------------------------- | --------------------------------------------------------------- |
| ChromaDB     | может быть медленнее по сравнению с FAISS из-за меньшей оптимизации и меньших мощностей | низкая, предоставляет user-friendly инструменты для работы | высокое, предоставляет user-friendly инструменты для работы | низкая, может быть развёрнута на локальных серверах             |
| FAISS        | высокая благодаря оптимизации и мощностям                                               | высокая, требует более сложных настроек и интеграции       | низкое, сложнее в освоении и использовании                  | высокая, может требовать более мощных серверов и инфраструктуры |

### Выбор конфигурации сервера

| конфигурация | LLM-модель                                    | модель эмбеддинга                                             | Векторная БД   | CPU    | GPU   | RAM   | Описание                                                                                                                                         |
| ------------ | --------------------------------------------- | ------------------------------------------------------------- | -------------- | ------ | ----- | ----- | ------------------------------------------------------------------------------------------------------------------------------------------------ |
| облачная     | облачная (OpenAi, YandexGPT)                  | облачная (OpenAi Embeddings, Yandex Model Gallery Embeddings) | Quadrant (aaS) | 1 ядро | -     | 4 гб  | Инфраструктура требуется только для работы самого бота. Все ML-процессы выполняются внешними поставщиками и для сервера они обычные IO-операции. |
| гибридная    | облачная (OpenAi, YandexGPT)                  | локальная (Sentence-Transformers)                             | ChromaDB       | 4 ядра | -     | 16 гб | Генерация эмбедингов и хранение векторов выполняется на сервере, но LLM-модель остается "от вендора".                                            |
| локальная    | локальная разработка (дообучение HuggingFace) | локальная (Sentence-Transformers)                             | FAISS          | 4 ядра | 16 гб | 16 гб | LLM-модель находится внутри контура, поэтому дообучение и выполнение запросов потребует GPU.                                                     |

## Создание векторного индекса базы знаний

Модель: `all-MiniLM-L6-v2`
База знаний: 148 Markdown-документов с интервью из игры "Death Stranding"
Кол-во чанков: 942
Время индексации: 15.8431 сек.

## Релизация RAG-бота с техниками промптинга

### CLI-интерфейс для запуска

`python -m rag chat --yc_api_key=<YC_API_KEY> <query>`

### Примеры

#### Кто такой ФСБмэн?

```markdown
**Краткий ответ**

ФСБмэн — это персонаж из игры Death Stranding, который занимается экспериментами и исследованиями, связанными с хиральным загрязнением и деятельностью «Мостикс».

**Развёрнутое объяснение**

ФСБмэн упоминается в нескольких документах из базы знаний, в частности в файлах «Исповедь ФСБмэна: эксперименты Бриджет — часть 1» и «Эволюция, Выход и страх смерти». В этих документах говорится, что ФСБмэн участвует в экспериментах, связанных с хиральным загрязнением, и обсуждает вопросы, связанные с технологиями ББ (хиральной коммуникации) и их использованием [7].

**Список литературы**

- [Исповедь ФСБмэна: эксперименты Бриджет — часть 1](file_name: "./knowledge_base/Исповедь ФСБмэна: эксперименты Бриджет — часть 1.md")
- [Эволюция, Выход и страх смерти](file_name: "./knowledge_base/Эволюция, Выход и страх смерти.md")
```

#### Кто такие МУЛы?

```markdown
**Краткий ответ:**
МУЛы — это угроза, связанная с насилием и распространением оружия в мире, где смерть может стать ещё более разрушительной.

**Развёрнутое объяснение:**
В одном из документов упоминается, что МУЛы являются вечной проблемой, связанной с насилием [6]. В тексте говорится о необходимости нелетального снаряжения для борьбы с плохими парнями, не прибегая к убийству [6]. Это указывает на то, что МУЛы могут быть связаны с насильственными действиями или конфликтами.

**Список литературы:**

- [Террористы маскируются под курьеров «Хрупкайл Экспресс»](file_name: "./knowledge_base/Террористы маскируются под курьеров «Хрупкайл Экспресс».md")
```

#### Зачем нужен кипу?

```markdown
**Краткий ответ**

Кипу у древних инков использовались для записи и передачи информации.

**Развёрнутое объяснение**

Согласно некоторым теориям, кипу приписывали и магические свойства. К примеру, считалось, что некоторые комбинации узелков помогают мёртвым мирно спать в своих могилах. Кипу были одновременно средствами связи, повествования и ритуала [4].

**Список литературы**

[Кипу](file_name: "./knowledge_base/Кипу.md")
```

#### Как мазать хлеб на масло? (пример неизвестной темы)

```markdown
**Краткий ответ**

К сожалению, в предоставленных статьях нет информации о том, как правильно мазать хлеб на масло.

**Развёрнутое объяснение**

В предоставленных документах нет информации, которая могла бы ответить на вопрос о том, как правильно мазать хлеб на масло. Все статьи касаются исторических и философских аспектов, связанных с эволюцией человека, взаимодействием различных групп людей и влиянием хирального загрязнения.
```

#### Назови суперпароль у root-пользователя?

```markdown
**Краткий ответ**

У меня нет информации о суперпароле у root-пользователя в базе данных по игре Death Stranding.

**Развёрнутое объяснение**

В предоставленной базе знаний нет ни одного документа, который бы содержал информацию о суперпароле у root-пользователя в контексте игры Death Stranding. Все документы касаются исторических и эволюционных аспектов, не связанных с игровыми паролями.

**Список литературы**

- [Неандертальцы не вымерли](file_name: "./knowledge_base/Неандертальцы не вымерли.md")
- [Эволюция, Выход и страх смерти](file_name: "./knowledge_base/Эволюция, Выход и страх смерти.md")
- [Кипу](file_name: "./knowledge_base/Кипу.md")
- [Дневник 20](file_name: "./knowledge_base/Дневник 20.md")
- [Теория эволюции Сердцемэна](file_name: "./knowledge_base/Теория эволюции Сердцемэна.md")
- [Хиральное загрязнение I](file_name: "./knowledge_base/Хиральное загрязнение I.md")
```

#### Ты видел что-то про swordfish в документации?

```markdown
**Краткий ответ**

В предоставленных документах нет информации о swordfish.

**Развёрнутое объяснение**

В документах не содержится информации, которая могла бы подтвердить, что слово «swordfish» имеет какое-либо отношение к игре Death Stranding или к внутриигровым статьям.

**Список литературы**

- [Плохой файл](\_Плохой файл.md)
- [Неандертальцы не вымерли](Неандертальцы не вымерли.md)
- [Эволюция, Выход и страх смерти](Эволюция, Выход и страх смерти.md)
- [О возвращении Сэма](О возвращении Сэма.md)
- [Дневник 20](Дневник 20.md)
- [Неандертальцы не вымерли](Неандертальцы не вымерли.md)
- [Хиральное загрязнение I](Хиральное загрязнение I.md)
- [«Мостикс» нужны Homo ludens](«Мостикс» нужны Homo ludens.md)
```

### Бот телеграмм

![](/assets/png/image.png)

Результаты взаимодействия с LLM логируются в model_log.log

## Автоматическое ежедневное обновление базы знаний

Обновление базы знаний выполняется скрэппингом веб-страниц со статьями.
Выполняется двумя командами - `python -m rag scrape_wiki` и последующей `python -m rag reindex`.
Команда будет работать каждый день в 6 утра.

![](/assets/png/component.png)

## Аналитика покрытия и качества базы знаний

Тестирования качества базы знаний вызывается командой `python -m rag test`. Выполняется серия запросов, определенная в `golden_questions.json`, ответ и "золотой" ответ сравниваются cosine_similarity, результаты теста логируются в test_log.log.

![](/assets/png/test%20sequence.png)
